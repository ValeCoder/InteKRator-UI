<div class="manager-layout">
    <!-- List Section -->
    <aside class="dataset-list card" [class.collapsed]="isSidebarCollapsed()">
        <div class="list-header">
            <h3 *ngIf="!isSidebarCollapsed()">Datensätze</h3>
            <div class="header-actions">
                <button class="btn-icon small" (click)="toggleSidebar()">
                    <lucide-icon [name]="isSidebarCollapsed() ? 'chevron-right' : 'chevron-left'"
                        class="icon-sm"></lucide-icon>
                </button>
            </div>
        </div>

        <button *ngIf="!isSidebarCollapsed()" class="btn-primary small full-width-btn" (click)="createNew()">
            <lucide-icon name="plus" class="icon-sm"></lucide-icon> Neu
        </button>

        <div class="list-content" *ngIf="!isSidebarCollapsed()">
            <div *ngFor="let ds of datasets()" class="list-item" [class.active]="selectedDataset()?.id === ds.id"
                (click)="selectDataset(ds)">
                <div class="item-info">
                    <span class="item-name">{{ ds.name }}</span>
                    <span class="item-meta">{{ ds.versions.length }} Versionen</span>
                </div>
                <div class="item-actions">
                    <button class="btn-icon text-danger" (click)="deleteDataset(ds); $event.stopPropagation()">
                        <lucide-icon name="trash-2" class="icon-sm"></lucide-icon>
                    </button>
                </div>
            </div>
        </div>

        <!-- Collapsed State Icons -->
        <div class="list-content collapsed-icons" *ngIf="isSidebarCollapsed()">
            <div *ngFor="let ds of datasets()" class="list-item icon-only"
                [class.active]="selectedDataset()?.id === ds.id" (click)="selectDataset(ds)" title="{{ds.name}}">
                <span class="item-initial">{{ ds.name.charAt(0) }}</span>
            </div>
            <button class="btn-icon icon-only add-btn" (click)="createNew()" title="Neuer Datensatz">
                <lucide-icon name="plus" class="icon-sm"></lucide-icon>
            </button>
        </div>
    </aside>

    <!-- Editor Section -->
    <section class="dataset-editor" *ngIf="selectedDataset(); else emptyState">
        <div class="editor-header">
            <div class="header-info">
                <input class="title-input" [(ngModel)]="selectedDataset()!.name" placeholder="Name des Datensatzes">
            </div>
            <div class="tab-navigation">
                <button class="tab-btn" [class.active]="viewMode() === 'new'" (click)="setViewMode('new')">
                    <lucide-icon name="upload" class="icon-sm"></lucide-icon> Neue Version
                </button>
                <button class="tab-btn" [class.active]="viewMode() === 'history'" (click)="setViewMode('history')">
                    <lucide-icon name="history" class="icon-sm"></lucide-icon> Historie / Versionen
                </button>
                <button class="btn-secondary small" (click)="toggleManualMode()" *ngIf="viewMode() === 'new'">
                    {{ isManualMode() ? 'Zu Datei-Upload wechseln' : 'Manuell im Grid erstellen' }}
                </button>
            </div>
        </div>

        <div class="management-content">
            <!-- New Version Tab -->
            <div class="tab-content" *ngIf="viewMode() === 'new'">


                <!-- File Upload Form -->
                <div class="upload-form" *ngIf="!isManualMode()">
                    <div class="form-row">
                        <div class="form-group flex-1">
                            <label>Versionsnummer *</label>
                            <input type="text" [(ngModel)]="versionNumber" placeholder="z.B. 1.0.1" class="input-base">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Datei (.txt, .dat) *</label>
                        <div class="drag-drop-zone" [class.drag-over]="isDragOver()" (dragover)="onDragOver($event)"
                            (dragleave)="onDragLeave($event)" (drop)="onDrop($event)">
                            <input type="file" (change)="onFileSelected($event)" accept=".txt,.dat" #fileInput hidden>
                            <div class="drop-content" (click)="fileInput.click()">
                                <lucide-icon name="upload" class="icon-xl"></lucide-icon>
                                <p *ngIf="!selectedFile" class="text-lg font-medium text-gray-200">Datei hier
                                    ablegen oder klicken zum Auswählen</p>
                                <p *ngIf="selectedFile" class="selected-file-name">{{ selectedFile.name }}</p>
                                <span class="file-hint text-sm text-gray-500 mt-2">.txt oder .dat Dateien</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Notizen</label>
                        <textarea [(ngModel)]="versionNotes" placeholder="Was hat sich geändert?" class="input-base"
                            rows="3"></textarea>
                    </div>

                    <div class="form-actions">
                        <button class="btn-primary" (click)="uploadVersion()"
                            [disabled]="!selectedFile || !versionNumber">
                            Hochladen
                        </button>
                    </div>
                </div>

                <!-- Manual Grid Editor -->
                <div class="manual-editor" *ngIf="isManualMode()">
                    <div class="form-group">
                        <label>Versionsnummer *</label>
                        <input type="text" [(ngModel)]="versionNumber" placeholder="z.B. 1.0.1" class="input-base"
                            style="max-width: 200px;">
                    </div>

                    <div class="schema-config">
                        <label class="text-secondary">Spalten:</label>
                        <div class="schema-chips">
                            <span *ngFor="let col of manualColumns(); let i = index" class="chip">
                                {{ col }} <lucide-icon name="x" class="remove icon-xs"
                                    (click)="removeColumn(i)"></lucide-icon>
                            </span>
                            <input #newColInput (keyup.enter)="addColumn(newColInput.value); newColInput.value=''"
                                placeholder="+ Spalte" class="chip-input input-base">
                        </div>
                    </div>

                    <div class="data-grid-container-mini">
                        <div class="data-grid"
                            [style.grid-template-columns]="'repeat(' + manualColumns().length + ', 1fr) 40px'">
                            <!-- Headers -->
                            <div class="grid-header" *ngFor="let col of manualColumns()">{{ col }}</div>
                            <div class="grid-header"></div>

                            <!-- Rows -->
                            <ng-container *ngFor="let row of manualGrid(); let rIndex = index">
                                <input *ngFor="let cell of row; let cIndex = index" [ngModel]="cell"
                                    (ngModelChange)="updateCell(rIndex, cIndex, $event)" class="grid-cell">
                                <button class="delete-row" (click)="deleteRow(rIndex)">
                                    <lucide-icon name="trash-2" class="icon-sm"></lucide-icon>
                                </button>
                            </ng-container>

                            <button class="add-row-btn" [style.grid-column]="'1 / -1'" (click)="addRow()">
                                <lucide-icon name="plus" class="icon-xs"></lucide-icon> Zeile hinzufügen
                            </button>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button class="btn-primary" (click)="saveManualVersion()" [disabled]="!versionNumber">
                            Manuelle Version speichern
                        </button>
                    </div>
                </div>
            </div>

            <!-- Version History Tab -->
            <div class="tab-content" *ngIf="viewMode() === 'history'">
                <div class="history-list">
                    <div *ngFor="let v of selectedDataset()?.versions" class="version-item">
                        <div class="version-info">
                            <div class="v-header">
                                <span class="v-number">v{{ v.versionNumber }}</span>
                                <span class="v-date">{{ v.createdAt | date:'dd.MM.yyyy HH:mm' }}</span>
                            </div>
                            <p class="v-notes" *ngIf="v.notes">{{ v.notes }}</p>
                        </div>
                        <div class="v-actions">
                            <button class="btn-icon text-danger" (click)="deleteVersion(v)">
                                <lucide-icon name="trash-2" class="icon-sm"></lucide-icon>
                            </button>
                        </div>
                    </div>
                    <div *ngIf="selectedDataset()?.versions?.length === 0" class="empty-mini">
                        Keine Versionen vorhanden.
                    </div>
                </div>
            </div>
        </div>
    </section>

    <ng-template #emptyState>
        <div class="empty-state card">
            <div class="empty-content">
                <lucide-icon name="file-spreadsheet" class="icon-xl text-secondary"></lucide-icon>
                <h3>Kein Datensatz ausgewählt</h3>
                <p class="text-secondary">Wähle einen Datensatz aus oder erstelle einen neuen, um zu beginnen.</p>
                <button class="btn-primary" (click)="createNew()">
                    <lucide-icon name="plus" class="icon-md"></lucide-icon> Neuen Datensatz erstellen
                </button>
            </div>
        </div>
    </ng-template>
</div>