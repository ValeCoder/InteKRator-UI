<div class="manager-layout">
    <!-- List Section -->
    <aside class="dataset-list card">
        <div class="list-header">
            <h3>Datensätze</h3>
            <button class="btn-primary small" (click)="createNew()">
                <lucide-icon name="plus" class="icon-sm"></lucide-icon> Neu
            </button>
        </div>

        <div class="list-content">
            <div *ngFor="let ds of datasets()" class="list-item" [class.active]="selectedDataset()?.id === ds.id"
                (click)="selectDataset(ds)">
                <div class="item-info">
                    <span class="item-name">{{ ds.name }}</span>
                    <span class="item-meta">{{ ds.versions.length }} Versionen</span>
                </div>
                <div class="item-actions">
                    <button class="btn-icon text-danger" (click)="deleteDataset(ds); $event.stopPropagation()">
                        <lucide-icon name="trash-2" class="icon-sm"></lucide-icon>
                    </button>
                </div>
            </div>
        </div>
    </aside>

    <!-- Editor Section -->
    <section class="dataset-editor card" *ngIf="selectedDataset(); else emptyState">
        <div class="editor-header">
            <div class="header-info">
                <input class="title-input" [(ngModel)]="selectedDataset()!.name" placeholder="Name des Datensatzes">
            </div>
        </div>

        <div class="management-grid">
            <!-- Upload Section -->
            <div class="upload-section">
                <div class="section-title-row">
                    <h4><lucide-icon name="upload" class="icon-sm"></lucide-icon> Neue Version</h4>
                    <button class="btn-secondary small" (click)="toggleManualMode()">
                        {{ isManualMode() ? 'Zu Datei-Upload wechseln' : 'Manuell im Grid erstellen' }}
                    </button>
                </div>

                <!-- File Upload Form -->
                <div class="upload-form" *ngIf="!isManualMode()">
                    <div class="form-group">
                        <label>Versionsnummer *</label>
                        <input type="text" [(ngModel)]="versionNumber" placeholder="z.B. 1.0.1" class="input-base">
                    </div>
                    <div class="form-group">
                        <label>Notizen</label>
                        <textarea [(ngModel)]="versionNotes" placeholder="Was hat sich geändert?"
                            class="input-base"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Datei (.txt, .dat) *</label>
                        <input type="file" (change)="onFileSelected($event)" accept=".txt,.dat" class="input-base">
                    </div>
                    <button class="btn-primary" (click)="uploadVersion()" [disabled]="!selectedFile || !versionNumber">
                        Hochladen
                    </button>
                </div>

                <!-- Manual Grid Editor -->
                <div class="manual-editor" *ngIf="isManualMode()">
                    <div class="form-group">
                        <label>Versionsnummer *</label>
                        <input type="text" [(ngModel)]="versionNumber" placeholder="z.B. 1.0.1" class="input-base">
                    </div>

                    <div class="schema-config">
                        <label class="text-secondary">Spalten:</label>
                        <div class="schema-chips">
                            <span *ngFor="let col of manualColumns(); let i = index" class="chip">
                                {{ col }} <lucide-icon name="x" class="remove icon-xs"
                                    (click)="removeColumn(i)"></lucide-icon>
                            </span>
                            <input #newColInput (keyup.enter)="addColumn(newColInput.value); newColInput.value=''"
                                placeholder="+ Spalte" class="chip-input input-base">
                        </div>
                    </div>

                    <div class="data-grid-container-mini">
                        <div class="data-grid"
                            [style.grid-template-columns]="'repeat(' + manualColumns().length + ', 1fr) 40px'">
                            <!-- Headers -->
                            <div class="grid-header" *ngFor="let col of manualColumns()">{{ col }}</div>
                            <div class="grid-header"></div>

                            <!-- Rows -->
                            <ng-container *ngFor="let row of manualGrid(); let rIndex = index">
                                <input *ngFor="let cell of row; let cIndex = index" [ngModel]="cell"
                                    (ngModelChange)="updateCell(rIndex, cIndex, $event)" class="grid-cell">
                                <button class="delete-row" (click)="deleteRow(rIndex)">
                                    <lucide-icon name="trash-2" class="icon-xs"></lucide-icon>
                                </button>
                            </ng-container>

                            <button class="add-row-btn" [style.grid-column]="'1 / -1'" (click)="addRow()">
                                <lucide-icon name="plus" class="icon-xs"></lucide-icon> Zeile hinzufügen
                            </button>
                        </div>
                    </div>

                    <button class="btn-primary full-width" (click)="saveManualVersion()" [disabled]="!versionNumber">
                        Manuelle Version speichern
                    </button>
                </div>
            </div>

            <!-- Version History -->
            <div class="history-section">
                <h4><lucide-icon name="history" class="icon-sm"></lucide-icon> Versionen</h4>
                <div class="version-list">
                    <div *ngFor="let v of selectedDataset()?.versions" class="version-item">
                        <div class="version-info">
                            <span class="v-number">v{{ v.versionNumber }}</span>
                            <span class="v-date">{{ v.createdAt | date:'dd.MM.yyyy HH:mm' }}</span>
                            <p class="v-notes" *ngIf="v.notes">{{ v.notes }}</p>
                        </div>
                        <div class="v-actions">
                            <button class="btn-icon text-danger" (click)="deleteVersion(v)">
                                <lucide-icon name="trash-2" class="icon-sm"></lucide-icon>
                            </button>
                        </div>
                    </div>
                    <div *ngIf="selectedDataset()?.versions?.length === 0" class="empty-mini">
                        Keine Versionen vorhanden.
                    </div>
                </div>
            </div>
        </div>
    </section>

    <ng-template #emptyState>
        <div class="empty-state card">
            <div class="empty-content">
                <lucide-icon name="file-spreadsheet" class="icon-xl text-secondary"></lucide-icon>
                <h3>Kein Datensatz ausgewählt</h3>
                <p class="text-secondary">Wähle einen Datensatz aus oder erstelle einen neuen, um zu beginnen.</p>
                <button class="btn-primary" (click)="createNew()">
                    <lucide-icon name="plus" class="icon-md"></lucide-icon> Neuen Datensatz erstellen
                </button>
            </div>
        </div>
    </ng-template>
</div>