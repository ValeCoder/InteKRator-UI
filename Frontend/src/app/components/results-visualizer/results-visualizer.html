<div class="results-layout">
    <!-- Input Panel -->
    <section class="input-panel card">
        <div class="panel-header">
            <div class="header-main">
                <h3>Entscheidung erklären</h3>
                <p class="subtitle text-secondary">Parameter eingeben, um den Entscheidungspfad zu sehen</p>
            </div>
            <lucide-icon name="info" class="text-secondary icon-lg"></lucide-icon>
        </div>

        <div class="input-form">
            <div class="selectors-group">
                <div class="form-section">
                    <label class="section-label">Datensatz</label>
                    <select class="select-input input-base" #dsSelect (change)="onSelectDataset(dsSelect.value)">
                        <option value="" disabled [selected]="!selectedDataset()">Datensatz wählen...</option>
                        <option *ngFor="let ds of datasets()" [value]="ds.id">
                            {{ ds.name }}
                        </option>
                    </select>
                </div>

                <div class="form-section" *ngIf="selectedDataset()">
                    <label class="section-label">Version</label>
                    <select class="select-input input-base" #verSelect (change)="onSelectVersion(verSelect.value)">
                        <option value="" disabled [selected]="!selectedVersion()">Version wählen...</option>
                        <option *ngFor="let v of selectedDataset()?.versions" [value]="v.id">
                            Version {{ v.versionNumber }} ({{ v.createdAt | date:'shortDate' }})
                        </option>
                    </select>
                </div>
            </div>

            <div *ngIf="isLoading()" class="loading-state">
                <p>Lade Ergebnisse...</p>
            </div>

            <div *ngIf="hasNoTraining()" class="warning-box">
                <div class="warning-icon">
                    <lucide-icon name="info" class="icon-sm"></lucide-icon>
                </div>
                <div class="warning-content">
                    <p class="warning-title">Kein Training vorhanden</p>
                    <p class="warning-text">Für diese Version wurde noch kein Training durchgeführt.</p>
                </div>
            </div>

            <div class="form-section" *ngIf="latestResult()">
                <label class="section-label">Zustandsparameter</label>
                <div class="inputs-grid">
                    <div class="input-group"
                        *ngFor="let col of getSafeColumns(selectedVersion()).slice(0, -1); let i = index">
                        <label>{{ col }}</label>
                        <input [(ngModel)]="currentInputs[i]" class="param-input input-base"
                            placeholder="Wert eingeben">
                    </div>
                </div>
            </div>

            <button class="btn-secondary full-width" (click)="resetInference()" *ngIf="latestResult()"
                [style.margin-bottom.px]="8" title="Eingaben und Visualisierung zurücksetzen">
                <lucide-icon name="rotate-ccw" class="icon-sm"></lucide-icon>
                <span>Zurücksetzen</span>
            </button>

            <button class="btn-primary full-width" (click)="runInference()"
                [disabled]="!latestResult() || isLoading() || isInferring()">
                <lucide-icon name="loader" class="icon-sm spin" *ngIf="isInferring()"></lucide-icon>
                <lucide-icon name="search" class="icon-sm" *ngIf="!isInferring()"></lucide-icon>
                <span>{{ isInferring() ? 'Analysiere...' : 'Entscheidung analysieren' }}</span>
            </button>

            <div *ngIf="inferenceResultText()" class="inference-result">
                <h4>Analyse-Ergebnis</h4>
                <div>{{ inferenceResultText() }}</div>
            </div>
        </div>
    </section>

    <!-- Visualization Panel -->
    <section class="viz-panel card">
        <div class="panel-header">
            <h3>Regel-Visualisierung</h3>
            <div class="header-actions">
                <span *ngIf="latestResult()" class="status-badge success">
                    Modell trainiert am {{ latestResult()?.createdAt | date:'short' }}
                </span>
            </div>
        </div>

        <!-- Canvas Container -->
        <div class="viz-container" (wheel)="onWheel($event)" (mousedown)="startDrag($event)"
            (mousemove)="onDrag($event)" (mouseup)="stopDrag()" (mouseleave)="stopDrag()" [class.grabbing]="isDragging"
            [class.grab]="!isDragging && outcomes().length > 0">

            <!-- Floating Controls -->
            <div class="canvas-controls">
                <button class="btn-floating" (click)="resetView()" title="Ansicht zentrieren">
                    <lucide-icon name="maximize" class="icon-sm"></lucide-icon>
                </button>
            </div>

            <div *ngIf="outcomes().length === 0 && !isLoading()" class="empty-viz">
                <p class="text-secondary" *ngIf="!hasNoTraining()">Keine Ergebnisse zum Anzeigen.</p>
                <p class="text-secondary" *ngIf="hasNoTraining()">Kein Modell verfügbar.</p>
            </div>

            <!-- Movable Content Layer -->
            <div class="canvas-content"
                [style.transform]="'translate(' + transform.x + 'px, ' + transform.y + 'px) scale(' + transform.scale + ')'"
                *ngIf="outcomes().length > 0">

                <!-- SVG Overlay -->
                <!-- SVG should cover the graph layout size -->
                <svg class="lines-overlay" [attr.width]="svgWidth" [attr.height]="svgHeight">
                    <path *ngFor="let line of connectionLines" [attr.d]="line.path" class="connection-path"
                        [class.active]="line.active" [class.inferred]="line.inferred">
                    </path>
                </svg>

                <!-- Graph Layout -->
                <div class="graph-layout">

                    <!-- Column 1: Outcomes -->
                    <div class="column col-outcomes">
                        <div class="col-header">ERGEBNIS (OUTCOME)</div>
                        <div class="nodes-stack">
                            <div *ngFor="let outcome of outcomes()" class="node outcome-node" [id]="outcome.id"
                                #nodeElement>
                                <span class="outcome-label">{{ outcome.label }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Column 2: Rules -->
                    <div class="column col-rules">
                        <div class="col-header">REGELN</div>
                        <div class="nodes-stack">
                            <ng-container *ngFor="let outcome of outcomes()">
                                <div *ngFor="let rule of outcome.children" class="node rule-node" [id]="rule.id"
                                    #nodeElement (mouseenter)="setActiveRule(rule.id)"
                                    (mouseleave)="setActiveRule(null)" [class.active]="activeRuleId === rule.id"
                                    [class.inferred]="inferredRuleId === rule.id"
                                    [class.high-confidence]="(rule.confidence || 0) >= 0.95">

                                    <div class="rule-content">
                                        <span class="rule-title">{{ rule.label }}</span>
                                        <span class="conf-text">{{ (rule.confidence || 0) * 100 | number:'1.0-1'
                                            }}%</span>
                                    </div>
                                    <div class="conf-bar-bg">
                                        <div class="conf-bar-fill" [style.width.%]="(rule.confidence || 0) * 100"></div>
                                    </div>
                                </div>
                            </ng-container>
                        </div>
                    </div>

                    <!-- Column 3: Conditions -->
                    <div class="column col-conditions">
                        <div class="col-header">BEDINGUNGEN</div>
                        <div class="nodes-stack">
                            <ng-container *ngFor="let outcome of outcomes()">
                                <ng-container *ngFor="let rule of outcome.children">
                                    <div *ngFor="let cond of rule.children" class="node condition-node" [id]="cond.id"
                                        #nodeElement [class.active]="activeRuleId === rule.id"
                                        [class.inferred]="inferredRuleId === rule.id">
                                        <lucide-icon name="binary" class="icon-xs"></lucide-icon>
                                        <span>{{ cond.label }}</span>
                                    </div>
                                </ng-container>
                            </ng-container>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </section>
</div>